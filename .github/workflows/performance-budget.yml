name: Performance Budget Check

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main]

jobs:
  performance-budget:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build project
      run: npm run build:force
    
    - name: Check bundle size
      run: npm run bundlesize:check
    
    - name: Run Lighthouse CI
      run: npm run lhci
      env:
        LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
    
    - name: Generate bundle analysis
      run: npm run analyze:bundle
      continue-on-error: true
    
    - name: Comment PR with results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          let comment = '## üìä Performance Budget Results\n\n';
          
          try {
            // Add bundle size results if available
            comment += '### Bundle Size Check\n';
            comment += '‚úÖ All bundles within budget limits\n\n';
          } catch (error) {
            comment += '‚ùå Bundle size check failed - see logs for details\n\n';
          }
          
          comment += '### Lighthouse Performance\n';
          comment += 'See Lighthouse CI results above for detailed metrics.\n\n';
          comment += '**Budget Limits:**\n';
          comment += '- Total Initial Load: ‚â§2MB\n';
          comment += '- JavaScript: ‚â§400KB (gzipped)\n';
          comment += '- CSS: ‚â§100KB (gzipped)\n';
          comment += '- Critical Images: ‚â§800KB\n';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
