#!/usr/bin/env node
/**
 * Gallery Consolidation Script
 * - Reads tmp-gallery-consolidation-plan.json generated by scripts/gallery-inventory.mjs
 * - Copies chosen master images to public/gallery with proposed names
 * - Regenerates src/data/galleryImages.ts to reference only consolidated images
 * - Does NOT delete any files. Safe, additive changes only.
 *
 * Usage:
 *   node scripts/gallery-consolidate.mjs --dry-run   # default
 *   node scripts/gallery-consolidate.mjs --write     # perform copy + regenerate data file
 */

import fs from 'fs/promises';
import fssync from 'fs';
import path from 'path';

const repoRoot = process.cwd();
const PLAN_PATH = path.join(repoRoot, 'tmp-gallery-consolidation-plan.json');

const args = new Set(process.argv.slice(2));
const DO_WRITE = args.has('--write');

async function ensureDir(dir) {
  await fs.mkdir(dir, { recursive: true }).catch(() => {});
}

async function fileExists(p) {
  try {
    await fs.stat(p);
    return true;
  } catch {
    return false;
  }
}

function toPublicPath(absPath) {
  // Convert absolute path inside repo/public/... to public URL
  const rel = path.relative(path.join(repoRoot, 'public'), absPath).replace(/\\/g, '/');
  return `/${rel}`;
}

async function loadPlan() {
  const raw = await fs.readFile(PLAN_PATH, 'utf8');
  return JSON.parse(raw);
}

function sortByStableKey(a, b) {
  return a.localeCompare(b);
}

async function writeGalleryDataFile(publicPaths) {
  const target = path.join(repoRoot, 'src', 'data', 'galleryImages.ts');
  const content = `export const GALLERY_IMAGES = [\n${publicPaths
    .map((p) => `  "${p}"`)
    .join(',\n')}\n] as const;\n`;
  if (DO_WRITE) {
    await fs.writeFile(target, content, 'utf8');
  }
  return target;
}

async function copyIfNeeded(srcAbs, destAbs) {
  if (!DO_WRITE) return false;
  if (await fileExists(destAbs)) {
    // If exists, skip copy
    return false;
  }
  await ensureDir(path.dirname(destAbs));
  await fs.copyFile(srcAbs, destAbs);
  return true;
}

async function main() {
  if (!(await fileExists(PLAN_PATH))) {
    console.error('Plan not found. Run: node scripts/gallery-inventory.mjs');
    process.exit(1);
  }

  const plan = await loadPlan();
  const consolidatedFolder = path.join(repoRoot, plan.consolidatedFolder);
  const consolidatedPublicBase =
    '/' + path.relative(path.join(repoRoot, 'public'), consolidatedFolder).replace(/\\/g, '/');

  const copies = [];
  const publicPaths = [];

  for (const [key, group] of Object.entries(plan.groups)) {
    const chosen = group.chosen;
    const srcAbs = path.join(repoRoot, chosen.path);
    const destAbs = path.join(repoRoot, chosen.proposedNewPath);

    const didCopy = await copyIfNeeded(srcAbs, destAbs);
    const pub = toPublicPath(destAbs);
    publicPaths.push(pub);
    copies.push({ key, from: chosen.path, to: chosen.proposedNewPath, copied: !!didCopy });
  }

  publicPaths.sort(sortByStableKey);
  const dataFile = await writeGalleryDataFile(publicPaths);

  // Emit summary
  console.log('Gallery Consolidation Plan');
  console.log('===========================');
  console.log(`Mode: ${DO_WRITE ? 'WRITE' : 'DRY-RUN'}`);
  console.log(`Consolidated folder: ${plan.consolidatedFolder}`);
  console.log(`Groups: ${Object.keys(plan.groups).length}`);
  console.log(`Images to keep: ${plan.keptCount}`);
  console.log(`Images to delete (proposed): ${plan.deleteCount}`);
  console.log('');
  console.log(
    `Gallery data file: ${path.relative(repoRoot, dataFile)} ${DO_WRITE ? '(updated)' : '(preview only)'}`,
  );

  // Write a machine-readable report
  const report = {
    generatedAt: new Date().toISOString(),
    mode: DO_WRITE ? 'write' : 'dry-run',
    consolidatedFolder: plan.consolidatedFolder,
    totalGroups: Object.keys(plan.groups).length,
    keptCount: plan.keptCount,
    deleteCount: plan.deleteCount,
    copies,
    publicPaths,
  };
  const reportOut = path.join(repoRoot, 'gallery-consolidated-report.json');
  if (DO_WRITE) {
    await fs.writeFile(reportOut, JSON.stringify(report, null, 2), 'utf8');
  } else {
    // In dry-run, still print to stdout for inspection
    console.log('(dry-run) Sample entries:');
    console.log(JSON.stringify(report, null, 2).slice(0, 1500) + '\n...');
  }
}

main().catch((err) => {
  console.error(err);
  process.exit(1);
});
